name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'The version to release (e.g., v0.1.5 or v0.2.0)'
        required: true

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          pip install uv
          uv sync
          uv pip install pyinstaller

      - name: Run PyInstaller (from within uv env)
        run: |
          uv run pyinstaller --onefile --name portfolio-manager \
            --add-data "utils:utils" \
            --add-data "newrow.py:." \
            --collect-all numpy \
            --collect-all pandas \
            --collect-all matplotlib \
            --collect-all seaborn \
            --collect-all scipy \
            --collect-all yfinance \
            --collect-all peewee \
            --collect-all frozendict \
            --collect-all curl_cffi \
            --collect-all platformdirs \
            --collect-all websockets \
            --collect-all soupsieve \
            --hidden-import numpy \
            --hidden-import pandas \
            --hidden-import scipy \
            --hidden-import seaborn \
            --hidden-import matplotlib \
            --hidden-import yfinance \
            --hidden-import peewee \
            main.py

      - name: Archive Linux executable
        run: |
          mkdir -p artifact
          cp dist/portfolio-manager artifact/
          cd artifact
          zip portfolio-manager-linux.zip portfolio-manager
          cd ..
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: portfolio-manager-linux
          path: artifact/portfolio-manager-linux.zip

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          pip install uv
          uv sync
          uv pip install pyinstaller

      - name: Run PyInstaller (from within uv env)
        run: |
          uv run pyinstaller --onefile --name portfolio-manager `
            --add-data "utils:utils" `
            --add-data "newrow.py:." `
            --collect-all numpy `
            --collect-all pandas `
            --collect-all matplotlib `
            --collect-all seaborn `
            --collect-all scipy `
            --collect-all yfinance `
            --collect-all peewee `
            --collect-all frozendict `
            --collect-all curl_cffi `
            --collect-all platformdirs `
            --collect-all websockets `
            --collect-all soupsieve `
            --hidden-import numpy `
            --hidden-import pandas `
            --hidden-import scipy `
            --hidden-import seaborn `
            --hidden-import matplotlib `
            --hidden-import yfinance `
            --hidden-import peewee `
            main.py

      - name: Archive Windows executable
        run: |
          mkdir artifact
          copy dist\portfolio-manager.exe artifact\
          cd artifact
          powershell Compress-Archive -Path portfolio-manager.exe -DestinationPath portfolio-manager-windows.zip
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: portfolio-manager-windows
          path: artifact/portfolio-manager-windows.zip

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          pip install uv
          uv sync
          uv pip install pyinstaller

      - name: Run PyInstaller (from within uv env)
        run: |
          uv run pyinstaller --onefile --name portfolio-manager \
            --add-data "utils:utils" \
            --add-data "newrow.py:." \
            --collect-all numpy \
            --collect-all pandas \
            --collect-all matplotlib \
            --collect-all seaborn \
            --collect-all scipy \
            --collect-all yfinance \
            --collect-all peewee \
            --collect-all frozendict \
            --collect-all curl_cffi \
            --collect-all platformdirs \
            --collect-all websockets \
            --collect-all soupsieve \
            --hidden-import numpy \
            --hidden-import pandas \
            --hidden-import scipy \
            --hidden-import seaborn \
            --hidden-import matplotlib \
            --hidden-import yfinance \
            --hidden-import peewee \
            main.py

      - name: Archive macOS executable
        run: |
          mkdir -p artifact
          cp dist/portfolio-manager artifact/
          cd artifact
          zip portfolio-manager-macos.zip portfolio-manager
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: portfolio-manager-macos
          path: artifact/portfolio-manager-macos.zip

  release:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos]
    permissions:
      contents: write 
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/portfolio-manager-linux/portfolio-manager-linux.zip
            artifacts/portfolio-manager-windows/portfolio-manager-windows.zip
            artifacts/portfolio-manager-macos/portfolio-manager-macos.zip
          tag_name: ${{ github.event.inputs.version }}
          release_name: "Release ${{ github.event.inputs.version }}"
          body: |
            Automated release of portfolio-manager executables.

            **Note:** After downloading and unzipping, you must create a `config` folder in the same directory as the executable. You can copy the `config` folder from the repository.
